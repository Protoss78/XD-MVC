<!DOCTYPE html>
<html>
    <head>
        <!-- 1. Load platform support before any code that touches the DOM. -->
        <script src="../bower_components/webcomponentsjs/webcomponents.js"></script>
        <!-- 2. Load the component using an HTML Import -->
        <link rel="import" href="../elements/deprecated/image-element.html">
        <link rel="import" href="elements/model-element.html">
        <link rel="import" href="elements/model-tool.html">
        <link rel="import" href="elements/xdp2p-server.html">
        <link rel="import" href="elements/role-element.html">
        <link rel="import" href="../elements/deprecated/gallery-element.html">
        <link rel="import" href="../elements/deprecated/gallery-overview.html">
        <link rel="import" href="elements/xdp2p-available.html">
        <link rel="import" href="elements/xdp2p-connections.html">
        <link rel="import" href="elements/xdp2p-connect.html">
        <link rel="import" href="elements/xdp2p-tools.html">
        
        <link rel="stylesheet" href="../css/gallery.css" />
        <meta name="viewport" content="width=device-width, user-scalable=no">
    </head>
    <body>
        
        <polymer-element name="my-app" attributes="persistent transient" >
            <template>

                <model-element id="model" 
                               persistent='{ "albums": [], "large": [], "thumbs": []}'
                               transient = '{"current":0, "currentAlbum": ""}'
                               url= '/gallery';
                               >
                </model-element>
                <button on-click="{{showOverview}}" 
                        hidden?="{{$.roles.isselected.overview || $.roles.isseleced.viewer}}">
                    Albums
                </button>
                <gallery-overview hidden?="{{!$.roles.isselected.overview || !$.roles.isselected.owner}}"
                                  transient="{{$.model.transient}}" 
                                  persistent="{{$.model.persistent}}" 
                                  on-click="{{overviewClicked}}">
                </gallery-overview>
                <gallery-element transient="{{$.model.transient}}"
                                 persistent="{{$.model.persistent}}"
                                 hidden?="{{!$.roles.isselected.owner || $.roles.isselected.viewer ||  $.roles.isselected.overview }}">
                </gallery-element>
                <image-element hidden?="{{ (($.roles.isselected.overview || othersRoles.visitor > 0 ) && $.roles.isselected.owner)}}"
                               id="image"
                               transient="{{$.model.transient}}"
                               persistent="{{$.model.persistent}}"
                               showControls="{{$.roles.isselected.visitor}}"
                               showCover="{{$.roles.isselected.owner && $.roles.isselected.visitor}}">
                </image-element>
                <role-element id="roles"
                              roles="['owner', 'visitor', 'overview']"
                              selected="['overview']">
                </role-element>
                <xdp2p-server url='darroch.inf.ethz.ch' reconnect='true' show='true'></xdp2p-server>
                <xdp2p-tools transient="{{$.model.transient}}"
                             persistent="{{$.model.persistent}}"
                             roles="{{$.roles.roles}}"></xdp2p-tools>

            </template>
            <script>
                Polymer('my-app', {
                    created: function(){
                        this.othersRoles = XDp2p.othersRoles;
                        // TODO find a better way to enable/disable visual tools?
                        if (location.search === "?notools") {
                            console.log("no tools");
                            var sheet = window.document.styleSheets[0];
                            console.log(sheet);
                            sheet.insertRule('::shadow xdp2p-tools, ::shadow xdp2p-server, ::shadow role-element { display: none; }', sheet.cssRules.length);
                            
                        }
                    },

                    ready: function() {
                        console.log("ready");
                        // Gestures
                        var element = this.$.image;
                        var roleElement = this.$.roles;
                         
                        var right = Hammer(element).on("swiperight", function(event) {
                            element.previous();
                        });  
                        var left = Hammer(element).on("swipeleft", function(event) {
                            element.next();
                        });  
                        console.log(XDp2p.myPosition);
                        Object.observe(XDp2p.myPosition, function (changes) {
                            console.log("position changed");
                            // For testing, the first device is the owner
                            if (XDp2p.myPosition.value === 0) {
                                console.log("adding owner");
                                roleElement.addRole('owner');   
                                roleElement.removeRole('visitor');   
                          } else { // other devices are visitors
                                console.log("removing owner");
                                roleElement.removeRole('owner');   
                                roleElement.addRole('visitor');   
                            }
                        });
                    },
                    
                    overviewClicked: function() {
                        this.$.roles.removeRole('overview');
                    },

                    showOverview: function() {
                        this.$.roles.addRole('overview');
                    }
                    
                    
                });
            </script>
        </polymer-element>        
        <my-app></my-app>


        <script src="http://code.jquery.com/jquery-2.0.3.js"></script>
        <script src="../js/peer-0.3.8.js"></script>
        <script src="../js/hammer.js"></script>
        <script src="../js/XDp2p.js"></script>
<!--        <script src="js/viewer.js"></script> -->
 	
    </body>
</html>