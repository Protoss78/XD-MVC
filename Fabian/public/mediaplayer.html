<!DOCTYPE html>
<html ng-app="XDMediaplayer">

<head>
    <script type="text/javascript" src="/js/XDClient.js"></script>
    <script type="text/javascript" src="/js/peer-0.3.9.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.13/angular.js"></script>
    <script type="text/javascript" src="/js/controllers/mediaplayer.js"></script>
    <!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>-->
    <script>
        var library = {};
        var playlist = [];

        XDClient.registerObject(
            "library",
            library,
            null,
            function (sender, obj) {
                var parsedObject = JSON.parse(obj);
                for (var key in parsedObject) {
                    if (library[key] === undefined) {
                        //console.error(parsedObject[key]);
                        library[key] = parsedObject[key];
                    }
                }
                //library = JSON.parse(obj);
                reloadLibrary();
            });

        function reloadLibrary() {
            var libraryData = "<h3>Library</h3>";
            for (var key in library) {
                var file = library[key];
                libraryData = libraryData + '<div class="libraryEntry"><img id="preview' + key + '" width="40px" src="' + file.preview + '" /><br /><strong>' + key + '</strong><br />Owner: ' + file.contributor + '<br /><a onclick="javascript:addToPlaylist(' + key + ')" href="#">Add to Playlist</a></div>'
            }
            libraryData = libraryData + "<hr />";

            document.getElementById('library').innerHTML = libraryData;
        };

        function addFilesToLibrary() {
            var files = document.getElementById('files').files;

            for (var i = 0, f; f = files[i]; i++) {
                library[f.name] = {
                    "file": f,
                    "type": f.type,
                    "size": f.size,
                    "contributor": XDClient.userId
                };
                var reader = new FileReader();

                reader.onload = (function (f) {
                    return function (e) {
                        document.getElementById('preview' + f.name).src = e.target.result;
                        library[f.name].preview = e.target.result;
                    }
                })(f);

                reader.readAsDataURL(f);
            }

            reloadLibrary();
        }

        function addToPlaylist(id) {
            playlist[playlist.size] = {"id": id, "position": playlist[playlist.size - 1].position + 1, "status": "idle"};
            reloadPlaylist();
        }

        function reloadPlaylist() {
            var playlistContent;
            playlist.forEach(function (entry) {
                playlistContent = playlistContent + '<div style="float: left; width: 50px;"><img src="' + library[entry.id].preview + '" width="50" /><br />' + library[entry.id].file + '</div>';
            });
            document.getElementById('playlist').innerHTML = playlistContent;
        }
    </script>

    <link href="xdclient.css" rel="stylesheet" type="text/css">
</head>

<body>
    <div class="xdclient_connect" onClick="XDClient.connectToServer();"></div>
    <div class="xdclient_button" onClick="XDClient.showMenu();"></div>
    <div class="xdclient_menu" id="xdclient_menu" style="display:none"></div>
    <h1>Welcome to XDMediaPlayer</h1>
    <hr />
    <video width="320" height="240" src="" autobuffer autoplay controls>
        <div class="video-fallback">
            <br>Sie benoetigen einen Browser, der HTML5 unterstuetzt.
        </div>
    </video>
    <div class="playlist">
        <h3>Playlist</h3>
        <hr />
    </div>
    <div class="library" id="library">
        <h3>Library</h3>
        <hr />
    </div>
    <script>console.log(angular.element(document.getElementById('libraryController')).scope());</script>
    <ul ng-controller="libraryController" id="libraryController">
    <li ng-repeat="file in library">
        <img id="preview_{{file.key}}" width="40px" src="{{file.preview}}" /><br />
        <strong>{{file.key}}</strong><br />
        Owner: {{file.owner}}<br />
        <a onclick="javascript:addToPlaylist({{file.key}})" href="#">Add to Playlist</a>
    </li>
  </ul>
    <div class="mediaEdit">
        <h3>Add media</h3>
        <form>
            <input type="file" multiple name="files" id="files" accept="audio/*|video/*" />
            <input type="button" onclick="javascript:addFilesToLibrary();" value="Insert to Library" />
        </form>
    </div>
</body>

</html>
