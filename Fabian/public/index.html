<!DOCTYPE html>
<html>
<head>
	<script type="text/javascript" src="/js/XDClient.js"></script>
	<script type="text/javascript" src="/js/peer-0.3.9.js"></script>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    <script>
var map;
function initialize() {
  var mapOptions = {
    zoom: 8,
    center: new google.maps.LatLng(-34.397, 150.644)
  };
  map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);


	  XDClient.registerObject(
	  		"center",
	  		map.center,
			function(obj) {
		  		return {"lat": obj.lat(), "lng": obj.lng()}
				},
			function(sender, obj) {
				map.setCenter(new google.maps.LatLng(obj.lat, obj.lng));
			});

	 XDClient.registerObject(
	 	"zoom",
		map.getZoom(),
		function(obj) {
			return {"zoom": obj};
		},
		function(sender, obj) {
			map.setZoom(obj.zoom);
		});

	 XDClient.registerObject(
	 	"mapType",
		map.getMapTypeId(),
		function(obj) {
			return {"mapType" : obj};
		},
		function(sender, obj) {
			map.setMapTypeId(obj.mapType);
		});

    XDClient.registerObject(
        "bounds",
        map.getBounds(),
        function(obj) {
            if(obj !== undefined) {
            return {"ne" : {"lat": obj.getNorthEast().lat(), "lng" : obj.getNorthEast().lng()}, "sw" : {"lat" : obj.getSouthWest().lat(), "lng" : obj.getSouthWest().lng()}};
            }
        },
        null
    );

		XDClient.registerRole("sync all", ["center", "zoom", "mapType"]);
		XDClient.registerRole("center-only", ["center"]);

        var views = [];
		XDClient.registerRole(
			"show other's bounds",
			["bounds"],
			function(sender, args) {
                if(views[sender] === undefined) {
				views[sender] = new google.maps.Rectangle({
                strokeColor: '#' + (parseInt(parseInt(sender, 36).toExponential().slice(2,-5), 10) & 0xFFFFFF).toString(16).toUpperCase(),
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#' + (parseInt(parseInt(sender, 36).toExponential().slice(2,-5), 10) & 0xFFFFFF).toString(16).toUpperCase(),
                fillOpacity: 0.1,
                map: map,
                bounds: new google.maps.LatLngBounds(
                    new google.maps.LatLng(args.bounds.sw.lat, args.bounds.sw.lng),
                    new google.maps.LatLng(args.bounds.ne.lat, args.bounds.ne.lng)
                )
                });
                } else {
                    views[sender].setBounds(new google.maps.LatLngBounds(
                    new google.maps.LatLng(args.bounds.sw.lat, args.bounds.sw.lng),
                    new google.maps.LatLng(args.bounds.ne.lat, args.bounds.ne.lng)));
                }
            });
		XDClient.registerRole("zoom-only", ["zoom"]);
		XDClient.registerRole("zoom and center", ["center", "zoom"]);

  google.maps.event.addListener(map, 'center_changed', function() {
    // 3 seconds after the center of the map has changed, pan back to the
    // marker.
    window.setTimeout(function() {
      //map.panTo(marker.getPosition());
	  XDClient.updateObject("center", map.center);
    }, 100);
  });

  google.maps.event.addListener(map, 'maptypeid_changed', function() {
    // 3 seconds after the center of the map has changed, pan back to the
    // marker.
    window.setTimeout(function() {
      //map.panTo(marker.getPosition());
	  XDClient.updateObject("mapType", map.getMapTypeId());
    }, 100);
  });

  google.maps.event.addListener(map, 'zoom_changed', function() {
    // 3 seconds after the center of the map has changed, pan back to the
    // marker.
    window.setTimeout(function() {
      //map.panTo(marker.getPosition());
	  XDClient.updateObject("zoom", map.getZoom());
    }, 100);
  });

 google.maps.event.addListener(map, 'bounds_changed', function() {
    // 3 seconds after the center of the map has changed, pan back to the
    // marker.
    window.setTimeout(function() {
      //map.panTo(marker.getPosition());
	  XDClient.updateObject("bounds", map.getBounds());
    }, 100);
  });
}

google.maps.event.addDomListener(window, 'load', initialize);

    </script>
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px;
		font-family: Helvetica Neue;
      }
    </style>

    <link href="xdclient.css" rel="stylesheet" type="text/css">
</head>
<body>
<div class="xdclient_connect" onClick="XDClient.connectToServer();"></div>
<div class="xdclient_button" onClick="XDClient.showMenu();"></div>
<div class="xdclient_menu" id="xdclient_menu" style="display:none"></div>
<h1>Welcome to XDApp</h1>
<hr />
<div id="map-canvas"></div>
</body>
</html>
